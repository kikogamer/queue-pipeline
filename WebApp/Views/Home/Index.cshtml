@using WebApp.ViewModels
@{
    ViewData["Title"] = "Produtos";
}
@model List<ProdutoViewModel>

<div class="container mt-5">

    @{
        int row = 0;
    }

    @while (row < Model.Count)
    {
        <div class="row">
            @for (int i = 0; i < 3; i++)
            {
                if (row >= Model.Count) break;
                
                @await Html.PartialAsync("_Produto", Model[row]);
                row++;
            }
        </div>
    }
</div>

<!-- Carrinho de Compras Modal -->
<div class="modal fade" id="carrinhoModal" tabindex="-1" role="dialog" aria-labelledby="carrinhoModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="carrinhoModalLabel">Carrinho de Compras</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Fechar" onclick="fecharModal()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <ul class="d-flex flex-column list-group list-group-flush" id="itensCarrinho">
                    <li class="list-group-item">Seu carrinho está vazio.</li>
                </ul>
                <p id="totalCarrinho" class="fw-bold m-3"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="fecharModal()">Fechar</button>
                <a type="button" class="btn btn-primary" asp-area="" asp-controller="Checkout" asp-action="Index">Finalizar Compra</a>
            </div>
        </div>
    </div>
</div>

<script src="~/js/carrinho.js" asp-append-version="true"></script>
<script>

    var carrinho = getCarrinho();

    function adicionarCarrinho(id, produto, imagem, preco) {

        const objProduto = carrinho.find((item) => item.id === id);

        if (objProduto) {
            objProduto.quantidade++;
        }
        else {
            carrinho.push({ id: id, produto: produto, imagem: imagem, preco: preco, quantidade: 1 });
        }

        atualizarCarrinho();
        setCarrinho(carrinho);
    }

    function atualizarCarrinho() {
        var itensCarrinho = document.getElementById("itensCarrinho");
        itensCarrinho.innerHTML = ""; 
        
        if (carrinho.length === 0) {
            itensCarrinho.innerHTML = "<p>Seu carrinho está vazio.</p>";
        } else {
            carrinho.forEach(function(item) {
                var listItem = document.createElement("li");
                listItem.id = "item-carrinho-"+ item.id;
                listItem.className = "d-flex list-group-item";
                itensCarrinho.appendChild(listItem);
                var cardImage = document.createElement("div");
                cardImage.className = "card w-50";
                var image = document.createElement("img");
                image.src = "/images/"+ item.imagem;
                cardImage.appendChild(image);
                listItem.appendChild(cardImage);
                var description = document.createElement("div");
                description.className = "container-fluid justify-content-between d-flex flex-column";
                listItem.appendChild(description);
                var itemCarrinho = document.createElement("div");
                itemCarrinho.className = "d-flex justify-content-between";
                description.appendChild(itemCarrinho);
                var produto = document.createElement("p");
                produto.textContent = item.produto;
                itemCarrinho.appendChild(produto);
                var preco = document.createElement("div");
                preco.className = "fw-bold";
                preco.textContent = "R$ " + item.preco.toFixed(2);
                itemCarrinho.appendChild(preco);
                var quantidade = document.createElement("p");
                quantidade.innerHTML = "<div><label for='quantity'>Quantidade</label><input data-id='"+ item.id +"' class='form-control mt-2' type='number' name='quantity' value="+ item.quantidade +" style='width: 80px'/></div>";
                quantidade.addEventListener("change", onChangeQuantity);
                description.appendChild(quantidade);
            });

            totalizaCarrinho();
        }
        
        $('#carrinhoModal').modal('show');
    }

    function onChangeQuantity(e) {
        const itemCarrinho = carrinho.find((item) => item.id == e.target.dataset.id);
        const quantidade = e.target.value;

        if (quantidade == 0) {
            removeItemCarrinho(itemCarrinho);
        }
        else {
            itemCarrinho.quantidade = quantidade;
        }

        totalizaCarrinho();
        setCarrinho(carrinho);
    }

    function removeItemCarrinho(item) {
        var itemCarrinho = document.getElementById("item-carrinho-"+ item.id);
        itemCarrinho.remove();
        
        const idx = carrinho.indexOf(item);
        carrinho.splice(idx, 1);
        setCarrinho(carrinho);
    }

    function totalizaCarrinho() {
        const total = carrinho.reduce((result, item) => result + (item.quantidade * item.preco), 0);

        if (total == 0)
        {
            fecharModal();
            return;
        }

        var totalCarrinho = document.getElementById("totalCarrinho");
        totalCarrinho.textContent = "Total: R$ "+ total.toFixed(2);
    }

    function fecharModal() {
        $('#carrinhoModal').modal('hide');
    }
</script>